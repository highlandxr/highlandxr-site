---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

const allEvents = await getCollection("events");

const today = new Date();
today.setHours(0, 0, 0, 0);

const sortEvents = (a: (typeof allEvents)[number], b: (typeof allEvents)[number]) => {
  const aDate = new Date(a.data.date);
  const bDate = new Date(b.data.date);

  const aUpcoming = aDate.getTime() >= today.getTime();
  const bUpcoming = bDate.getTime() >= today.getTime();

  if (aUpcoming !== bUpcoming) return aUpcoming ? -1 : 1;
  if (aUpcoming) return aDate.getTime() - bDate.getTime();
  return bDate.getTime() - aDate.getTime();
};

const events = [...allEvents].sort(sortEvents);

const towns = [...new Set(events.map((event) => event.data.town))].sort((a, b) => a.localeCompare(b));
const categories = [...new Set(events.map((event) => event.data.category))].sort((a, b) =>
  a.localeCompare(b)
);

const dateFormat = new Intl.DateTimeFormat("en-GB", { dateStyle: "full" });
---

<BaseLayout title="Events" description="Find upcoming Highland XR events by town and category.">
  <h1>Events</h1>
  <p class="lead">
    Filter by town and category. Upcoming events are listed first, followed by past events.
  </p>

  <section class="surface filter-panel" aria-label="Event filters">
    <div class="filter-control">
      <label for="townFilter">Town</label>
      <select id="townFilter" name="town">
        <option value="all">All towns</option>
        {towns.map((town) => <option value={town.toLowerCase()}>{town}</option>)}
      </select>
    </div>
    <div class="filter-control">
      <label for="categoryFilter">Category</label>
      <select id="categoryFilter" name="category">
        <option value="all">All categories</option>
        {categories.map((category) => <option value={category.toLowerCase()}>{category}</option>)}
      </select>
    </div>
    <button type="button" id="resetFilters">Reset</button>
  </section>

  <ul id="eventsList" class="event-list">
    {
      events.map((event) => {
        const eventDate = new Date(event.data.date);
        const isUpcoming = eventDate.getTime() >= today.getTime();

        return (
          <li
            class="list-card event-card"
            data-town={event.data.town.toLowerCase()}
            data-category={event.data.category.toLowerCase()}
          >
            <div class="card-head">
              <span class="tag">{isUpcoming ? "Upcoming" : "Past"}</span>
              <span class="tag">{event.data.category}</span>
            </div>
            <h2>{event.data.title}</h2>
            <p class="meta">
              {dateFormat.format(eventDate)} • {event.data.town}
              {event.data.venue ? ` • ${event.data.venue}` : ""}
            </p>
            <p>{event.data.description}</p>
            <p class="card-links">
              <a href={`/events/${event.slug}/`}>Details</a>
              {event.data.externalUrl ? <a href={event.data.externalUrl}>External Link</a> : null}
            </p>
          </li>
        );
      })
    }
  </ul>

  <p id="noResults" class="lead no-results" hidden>No events match the selected filters.</p>
</BaseLayout>

<script>
  const townFilter = document.querySelector<HTMLSelectElement>("#townFilter");
  const categoryFilter = document.querySelector<HTMLSelectElement>("#categoryFilter");
  const resetButton = document.querySelector<HTMLButtonElement>("#resetFilters");
  const eventCards = Array.from(document.querySelectorAll<HTMLElement>(".event-card"));
  const noResults = document.querySelector<HTMLElement>("#noResults");

  if (townFilter && categoryFilter && resetButton) {
    const applyFilters = () => {
      const townValue = townFilter.value;
      const categoryValue = categoryFilter.value;

      let visibleCount = 0;

      for (const card of eventCards) {
        const matchesTown = townValue === "all" || card.dataset.town === townValue;
        const matchesCategory = categoryValue === "all" || card.dataset.category === categoryValue;
        const shouldShow = matchesTown && matchesCategory;

        card.hidden = !shouldShow;
        if (shouldShow) visibleCount += 1;
      }

      if (noResults) noResults.hidden = visibleCount !== 0;

      const search = new URLSearchParams();
      if (townValue !== "all") search.set("town", townValue);
      if (categoryValue !== "all") search.set("category", categoryValue);
      const query = search.toString();
      const nextPath = query ? `${window.location.pathname}?${query}` : window.location.pathname;
      history.replaceState({}, "", nextPath);
    };

    const params = new URLSearchParams(window.location.search);
    const townParam = params.get("town");
    const categoryParam = params.get("category");

    if (townParam && townFilter.querySelector(`option[value="${townParam}"]`)) {
      townFilter.value = townParam;
    }

    if (categoryParam && categoryFilter.querySelector(`option[value="${categoryParam}"]`)) {
      categoryFilter.value = categoryParam;
    }

    townFilter.addEventListener("change", applyFilters);
    categoryFilter.addEventListener("change", applyFilters);
    resetButton.addEventListener("click", () => {
      townFilter.value = "all";
      categoryFilter.value = "all";
      applyFilters();
    });

    applyFilters();
  }
</script>

<style>
  .filter-panel {
    display: flex;
    gap: 0.9rem;
    flex-wrap: wrap;
    align-items: end;
    padding: 1rem;
    margin: 1rem 0 1.4rem;
  }

  .filter-control {
    display: grid;
    gap: 0.3rem;
    min-width: min(220px, 100%);
  }

  label {
    font-size: 0.92rem;
    color: var(--muted);
  }

  select,
  button {
    border-radius: 9px;
    border: 1px solid var(--line);
    background: #fff;
    padding: 0.5rem 0.6rem;
    font: inherit;
    color: var(--text);
  }

  button {
    cursor: pointer;
    color: var(--accent);
    border-color: var(--accent);
    background: var(--accent-soft);
  }

  .event-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.95rem;
  }

  .event-card h2 {
    margin: 0.25rem 0 0.55rem;
    font-size: clamp(1.2rem, 2vw, 1.45rem);
  }

  .card-head {
    margin-bottom: 0.4rem;
  }

  .card-links {
    display: flex;
    gap: 0.8rem;
    flex-wrap: wrap;
    margin-bottom: 0;
  }

  .no-results {
    margin-top: 1.2rem;
  }
</style>
