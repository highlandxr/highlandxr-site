---
import { getCollection } from "astro:content";
import Badge from "../components/Badge.astro";
import Button from "../components/Button.astro";
import EmptyState from "../components/EmptyState.astro";
import FeaturedEventCard from "../components/FeaturedEventCard.astro";
import SectionHeader from "../components/SectionHeader.astro";
import StatCard from "../components/StatCard.astro";
import BaseLayout from "../layouts/BaseLayout.astro";

const [events, directoryEntries, fundingItems] = await Promise.all([
  getCollection("events"),
  getCollection("directory"),
  getCollection("funding")
]);

const today = new Date();
today.setHours(0, 0, 0, 0);

const nextEvent = [...events]
  .filter((event) => new Date(event.data.date).getTime() >= today.getTime())
  .sort((a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime())[0];

const stats = [
  {
    label: "Events",
    value: events.length,
    description: "Meetups, showcases, and workshops happening across Highland towns.",
    icon: "events" as const
  },
  {
    label: "Directory",
    value: directoryEntries.length,
    description: "Studios, educators, and community teams in one searchable network.",
    icon: "directory" as const
  },
  {
    label: "Funding",
    value: fundingItems.length,
    description: "Active grants and open calls for immersive projects and pilots.",
    icon: "funding" as const
  }
];
---

<BaseLayout
  title="Home"
  description="Highland XR is the XR hub for the Scottish Highlands with events, people, projects, and opportunities."
>
  <section
    id="heroSurface"
    class="relative overflow-hidden rounded-[1.6rem] border border-white/15 bg-gradient-to-b from-surface-panel via-surface-charcoal to-surface-deep px-6 pb-10 pt-10 md:px-10 md:pb-14 md:pt-14"
    aria-labelledby="hero-title"
  >
    <div aria-hidden="true" class="pointer-events-none absolute inset-0 bg-aurora opacity-90"></div>
    <div
      aria-hidden="true"
      class="pointer-events-none absolute inset-0 topo-grid opacity-30 [mask-image:linear-gradient(180deg,rgba(0,0,0,0.95),rgba(0,0,0,0.25))]"
    >
    </div>
    <div aria-hidden="true" class="hero-mouse-light pointer-events-none absolute inset-0 opacity-80 motion-reduce:hidden"></div>

    <svg
      aria-hidden="true"
      viewBox="0 0 1200 320"
      class="pointer-events-none absolute bottom-0 left-0 h-[45%] w-full min-h-[180px]"
      preserveAspectRatio="none"
    >
      <defs>
        <linearGradient id="hillShade" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="rgba(10,17,28,0.95)" />
          <stop offset="65%" stop-color="rgba(16,26,40,0.92)" />
          <stop offset="100%" stop-color="rgba(8,12,20,1)" />
        </linearGradient>
      </defs>
      <path
        d="M0,240 C120,188 210,174 310,205 C390,229 455,201 530,178 C600,156 670,154 744,180 C805,201 868,215 936,194 C1020,168 1098,167 1200,214 L1200,320 L0,320 Z"
        fill="url(#hillShade)"
      />
      <path
        d="M0,240 C120,188 210,174 310,205 C390,229 455,201 530,178 C600,156 670,154 744,180 C805,201 868,215 936,194 C1020,168 1098,167 1200,214"
        fill="none"
        stroke="rgba(92,227,215,0.48)"
        stroke-width="1.2"
      />
      <path
        d="M120,232 C240,196 340,198 440,225 C526,248 602,236 678,211 C760,184 852,180 932,206 C1010,231 1084,236 1160,220"
        fill="none"
        stroke="rgba(154,123,255,0.33)"
        stroke-width="1"
      />
      <path
        d="M250,210 L320,182 L410,190 L455,160 L552,171 L640,151 L738,168 L820,156"
        fill="none"
        stroke="rgba(141,187,156,0.46)"
        stroke-width="0.9"
        stroke-dasharray="2 5"
      />
    </svg>

    <div class="relative z-10 grid max-w-3xl gap-5">
      <p class="text-xs font-semibold uppercase tracking-[0.18em] text-brand-aurora">Scottish Highlands XR Network</p>
      <h1 id="hero-title" class="text-5xl md:text-6xl">Highland XR</h1>
      <p class="max-w-2xl text-base text-text-muted md:text-lg">
        The XR hub for the Scottish Highlands â€” events, people, projects, opportunities.
      </p>
      <div class="flex flex-wrap gap-3">
        <Button href="/events" variant="primary">Browse Events</Button>
        <Button href="/submit" variant="secondary">Submit an Event</Button>
      </div>
      <div class="flex flex-wrap gap-2 pt-1">
        <Badge tone="teal">{events.length} events tracked</Badge>
        <Badge tone="violet">{directoryEntries.length} directory entries</Badge>
        <Badge tone="highland">{fundingItems.length} funding calls</Badge>
      </div>
    </div>
  </section>

  <section class="section-space">
    <SectionHeader
      kicker="Community Snapshot"
      title="At a Glance"
      description="A quick view of activity across the Highland XR network."
    />

    <div class="mt-6 grid gap-4 md:grid-cols-3">
      {
        stats.map((stat) => (
          <StatCard label={stat.label} value={stat.value} description={stat.description} icon={stat.icon} />
        ))
      }
    </div>
  </section>

  <section class="section-space">
    <SectionHeader
      kicker="Featured Event"
      title="Next Upcoming Event"
      description="The nearest scheduled event from the Highland XR calendar."
    />

    <div class="mt-6">
      {
        nextEvent ? (
          <FeaturedEventCard
            title={nextEvent.data.title}
            description={nextEvent.data.description}
            date={new Date(nextEvent.data.date)}
            town={nextEvent.data.town}
            category={nextEvent.data.category}
            href={`/events/${nextEvent.slug}/`}
          />
        ) : (
          <EmptyState
            title="No upcoming events listed yet"
            description="Add a new event to start populating the Highland XR calendar."
            actionLabel="Submit an Event"
            actionHref="/submit"
          />
        )
      }
    </div>
  </section>
</BaseLayout>

<script>
  const hero = document.querySelector<HTMLElement>("#heroSurface");
  const reducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)");

  if (hero && !reducedMotion.matches) {
    const updatePointer = (event: PointerEvent) => {
      const rect = hero.getBoundingClientRect();
      const x = ((event.clientX - rect.left) / rect.width) * 100;
      const y = ((event.clientY - rect.top) / rect.height) * 100;
      hero.style.setProperty("--pointer-x", `${Math.max(0, Math.min(100, x))}%`);
      hero.style.setProperty("--pointer-y", `${Math.max(0, Math.min(100, y))}%`);
    };

    hero.addEventListener("pointermove", updatePointer);
    hero.addEventListener("pointerleave", () => {
      hero.style.setProperty("--pointer-x", "50%");
      hero.style.setProperty("--pointer-y", "25%");
    });
  }
</script>
