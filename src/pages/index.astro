---
import { getCollection } from "astro:content";
import Badge from "../components/Badge.astro";
import Card from "../components/Card.astro";
import EmptyState from "../components/EmptyState.astro";
import Hero from "../components/Hero.astro";
import SectionHeading from "../components/SectionHeading.astro";
import StatCards from "../components/StatCards.astro";
import BaseLayout from "../layouts/BaseLayout.astro";

const [events, directoryEntries, fundingItems] = await Promise.all([
  getCollection("events"),
  getCollection("directory"),
  getCollection("funding")
]);

const today = new Date();
today.setHours(0, 0, 0, 0);

const nextEvent = [...events]
  .filter((event) => new Date(event.data.date).getTime() >= today.getTime())
  .sort((a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime())[0];

const stats = [
  {
    label: "Events",
    value: events.length,
    description: "Meetups, workshops, and showcases across Highland towns.",
    icon: "events" as const
  },
  {
    label: "Directory",
    value: directoryEntries.length,
    description: "Studios, educators, and community groups in one place.",
    icon: "directory" as const
  },
  {
    label: "Funding",
    value: fundingItems.length,
    description: "Current grants and calls for immersive projects.",
    icon: "funding" as const
  }
];

const fullDateFormat = new Intl.DateTimeFormat("en-GB", { dateStyle: "full" });
const dateDayFormat = new Intl.DateTimeFormat("en-GB", { day: "2-digit" });
const dateMonthFormat = new Intl.DateTimeFormat("en-GB", { month: "short" });
const nextEventDate = nextEvent ? new Date(nextEvent.data.date) : null;
---

<BaseLayout
  title="Home"
  description="HighlandXR maps events, talent, and funding opportunities across the Scottish Highlands."
>
  <Hero
    kicker="Scottish Highlands XR Network"
    title="A practical hub for immersive work across the Highlands"
    description="Discover local events, connect with regional XR talent, and track live funding opportunities with a clean community-first platform."
    primaryLabel="Explore Events"
    primaryHref="/events"
    secondaryLabel="Submit Listing"
    secondaryHref="/submit"
  >
    <div slot="meta" class="hero-meta">
      <Badge tone="accent">{events.length} events tracked</Badge>
      <Badge tone="accent">{directoryEntries.length} directory entries</Badge>
      <Badge tone="accent">{fundingItems.length} funding calls</Badge>
    </div>
  </Hero>

  <section class="section-stack">
    <SectionHeading
      kicker="Community Snapshot"
      title="At a Glance"
      description="A quick view of current activity on HighlandXR."
    />
    <StatCards stats={stats} />
  </section>

  <section class="section-stack">
    <SectionHeading
      kicker="Featured"
      title="Next Upcoming Event"
      description="The nearest scheduled event from the HighlandXR calendar."
    />

    {
      nextEvent && nextEventDate ? (
        <Card
          className="featured-event"
          headingLevel="h2"
          title={nextEvent.data.title}
          href={`/events/${nextEvent.slug}/`}
        >
          <div slot="eyebrow" class="featured-event__eyebrow">
            <div class="date-pill" aria-label={`Date ${fullDateFormat.format(nextEventDate)}`}>
              <span class="date-pill__day">{dateDayFormat.format(nextEventDate)}</span>
              <span class="date-pill__month">{dateMonthFormat.format(nextEventDate)}</span>
            </div>
            <Badge tone="success">{nextEvent.data.town}</Badge>
            <Badge>{nextEvent.data.category}</Badge>
          </div>

          <p class="meta">{fullDateFormat.format(nextEventDate)}</p>
          <p class="lead">{nextEvent.data.description}</p>
        </Card>
      ) : (
        <EmptyState
          title="No upcoming events listed yet"
          description="Add a new event to start populating the HighlandXR calendar."
          actionLabel="Submit Event"
          actionHref="/submit"
        />
      )
    }
  </section>
</BaseLayout>

<style>
  .hero-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .featured-event {
    padding: clamp(var(--space-4), 2.5vw, var(--space-6));
  }

  .featured-event__eyebrow {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    align-items: center;
  }

  .date-pill {
    display: inline-grid;
    place-items: center;
    padding: 0.35rem 0.55rem;
    border-radius: 12px;
    border: 1px solid rgba(88, 209, 200, 0.45);
    background: rgba(88, 209, 200, 0.18);
    min-width: 3.2rem;
    line-height: 1;
  }

  .date-pill__day {
    font-size: 1.03rem;
    font-weight: 700;
    color: var(--color-ink-strong);
  }

  .date-pill__month {
    margin-top: 0.08rem;
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-muted);
  }
</style>
