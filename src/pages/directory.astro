---
import { getCollection } from "astro:content";
import Badge from "../components/Badge.astro";
import Button from "../components/Button.astro";
import Card from "../components/Card.astro";
import EmptyState from "../components/EmptyState.astro";
import SectionHeader from "../components/SectionHeader.astro";
import BaseLayout from "../layouts/BaseLayout.astro";

const entries = (await getCollection("directory")).sort((a, b) => a.data.title.localeCompare(b.data.title));

const towns = [...new Set(entries.map((entry) => entry.data.town))].sort((a, b) => a.localeCompare(b));
const categories = [...new Set(entries.map((entry) => entry.data.category))].sort((a, b) => a.localeCompare(b));
---

<BaseLayout title="Directory" description="Directory of XR studios, communities, and educators in the Highlands.">
  <SectionHeader
    level="h1"
    kicker="Directory"
    title="Highland XR Organizations"
    description="Studios, educators, and community groups active across the region."
  />

  <section class="filter-shell mt-7" aria-label="Directory filters">
    <div class="filter-field">
      <label class="filter-label" for="townFilter">Town</label>
      <select id="townFilter" class="filter-select">
        <option value="all">All towns</option>
        {towns.map((town) => <option value={town.toLowerCase()}>{town}</option>)}
      </select>
    </div>

    <div class="filter-field">
      <label class="filter-label" for="categoryFilter">Category</label>
      <select id="categoryFilter" class="filter-select">
        <option value="all">All categories</option>
        {categories.map((category) => <option value={category.toLowerCase()}>{category}</option>)}
      </select>
    </div>

    <div class="min-w-[180px] pt-1">
      <Button id="resetFilters" type="button" variant="ghost" className="w-full justify-center">Reset Filters</Button>
    </div>
  </section>

  <div class="section-space grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
    {
      entries.map((entry) => (
        <article class="directory-item" data-town={entry.data.town.toLowerCase()} data-category={entry.data.category.toLowerCase()}>
          <Card headingLevel="h2" title={entry.data.title} className="h-full">
            <div slot="eyebrow">
              <Badge tone="teal">{entry.data.category}</Badge>
              <Badge tone="highland">{entry.data.town}</Badge>
            </div>

            <p>{entry.data.summary}</p>

            <div slot="footer">
              {entry.data.website ? <Button href={entry.data.website} variant="ghost">Website</Button> : null}
              {entry.data.contactEmail ? (
                <a href={`mailto:${entry.data.contactEmail}`} class="text-sm text-brand-aurora">
                  Contact
                </a>
              ) : null}
            </div>
          </Card>
        </article>
      ))
    }
  </div>

  <div id="noResults" class="section-space" hidden>
    <EmptyState
      title="No directory entries match these filters"
      description="Try resetting filters or choose a different town/category combination."
      actionLabel="Reset Filters"
      actionHref="/directory"
    />
  </div>
</BaseLayout>

<script>
  const townFilter = document.querySelector<HTMLSelectElement>("#townFilter");
  const categoryFilter = document.querySelector<HTMLSelectElement>("#categoryFilter");
  const resetButton = document.querySelector<HTMLButtonElement>("#resetFilters");
  const cards = Array.from(document.querySelectorAll<HTMLElement>(".directory-item"));
  const noResults = document.querySelector<HTMLElement>("#noResults");

  if (townFilter && categoryFilter && resetButton) {
    const applyFilters = () => {
      const townValue = townFilter.value;
      const categoryValue = categoryFilter.value;
      let visibleCount = 0;

      for (const card of cards) {
        const matchesTown = townValue === "all" || card.dataset.town === townValue;
        const matchesCategory = categoryValue === "all" || card.dataset.category === categoryValue;
        const show = matchesTown && matchesCategory;
        card.hidden = !show;
        if (show) visibleCount += 1;
      }

      if (noResults) noResults.hidden = visibleCount !== 0;
    };

    townFilter.addEventListener("change", applyFilters);
    categoryFilter.addEventListener("change", applyFilters);
    resetButton.addEventListener("click", () => {
      townFilter.value = "all";
      categoryFilter.value = "all";
      applyFilters();
    });

    applyFilters();
  }
</script>
